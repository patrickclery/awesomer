#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../config/environment"

puts "ğŸ” GitHub API Rate Limit Status"
puts "=" * 40

# Check GitHub's actual rate limit
begin
  client = Octokit::Client.new(access_token: ENV["GITHUB_API_KEY"])
  rate_limit = client.rate_limit
  
  puts "\nğŸ“Š GitHub API Rate Limit (Official):"
  puts "  Remaining: #{rate_limit.remaining}/#{rate_limit.limit}"
  puts "  Resets at: #{Time.at(rate_limit.resets_at)}"
  puts "  Time until reset: #{rate_limit.resets_in} seconds"
  
  if rate_limit.remaining == 0
    puts "  ğŸš¨ RATE LIMITED! Wait #{rate_limit.resets_in} seconds"
  elsif rate_limit.remaining < 100
    puts "  âš ï¸  LOW: Only #{rate_limit.remaining} requests remaining"
  else
    puts "  âœ… OK: #{rate_limit.remaining} requests available"
  end
  
rescue => e
  puts "  âŒ Error checking GitHub rate limit: #{e.message}"
end

# Check our internal rate limiter
puts "\nğŸ›¡ï¸  Internal Rate Limiter (Redis-based):"
begin
  rate_limiter = GithubRateLimiterService.new
  puts "  Remaining: #{rate_limiter.requests_remaining}/4000"
  puts "  Can make request: #{rate_limiter.can_make_request?}"
  puts "  Time until reset: #{rate_limiter.time_until_reset} seconds"
rescue => e
  puts "  âŒ Error checking internal rate limiter: #{e.message}"
end

# Check recent API requests from database
puts "\nğŸ“‹ Recent API Requests (last hour):"
begin
  recent_requests = GithubApiRequest.recent(1.hour).order(requested_at: :desc).limit(10)
  if recent_requests.any?
    recent_requests.each do |req|
      status_emoji = case req.response_status
                    when 200 then "âœ…"
                    when 404 then "â“"
                    when 429 then "ğŸš¨"
                    else "âš ï¸"
                    end
      puts "  #{status_emoji} #{req.requested_at.strftime('%H:%M:%S')} - #{req.endpoint} (#{req.response_status})"
    end
    
    total_recent = GithubApiRequest.recent(1.hour).count
    successful_recent = GithubApiRequest.recent(1.hour).where(response_status: 200).count
    puts "\n  ğŸ“ˆ Summary (last hour):"
    puts "    Total requests: #{total_recent}"
    puts "    Successful: #{successful_recent}"
    puts "    Success rate: #{(successful_recent.to_f / total_recent * 100).round(1)}%" if total_recent > 0
  else
    puts "  No recent requests found"
  end
rescue => e
  puts "  âŒ Error checking recent requests: #{e.message}"
end

puts "\nğŸ’¡ Tips:"
puts "  â€¢ GitHub limit: 5,000 requests/hour for authenticated users"
puts "  â€¢ Our conservative limit: 4,000 requests/hour"
puts "  â€¢ Use --sync flag carefully with large repositories"
puts "  â€¢ Async mode (default) respects rate limits automatically" 