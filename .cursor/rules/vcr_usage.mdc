---
description: 
globs: 
alwaysApply: true
---
## VCR Cassette Management and Naming

This project uses VCR to record and replay HTTP interactions with external APIs, primarily the GitHub API.

### Directory Structure
- All VCR cassettes for GitHub API interactions should be stored in `spec/cassettes/github/`.

### Naming Convention
- Cassettes should be named to clearly indicate the repository and the primary purpose of the interactions recorded within.
  - For operations fetching specific data for a repository (e.g., README, repository details, commit history for README), use the pattern: `OWNER_REPONAME.yml` or `OWNER_REPONAME_purpose.yml`.
    - Example for fetching all details for `Polycarbohydrate/awesome-tor` by `FetchReadmeOperation`: `[polycarbohydrate_awesome-tor.yml](mdc:spec/cassettes/github/polycarbohydrate_awesome-tor.yml)`
    - Example for a non-existent repo test in `FetchReadmeOperation`: `[nonexistent-owner_nonexistent-repo-for-fetch-test.yml](mdc:spec/cassettes/github/nonexistent-owner_nonexistent-repo-for-fetch-test.yml)`
  - For operations that involve multiple repositories based on a fixture (e.g., `SyncGitStatsOperation` processing links from `awesome_self_hosted_snippet.md`), the cassette can be named after the fixture or the group of interactions:
    - Example: `[awesome_self_hosted_snippet_stats.yml](mdc:spec/cassettes/github/awesome_self_hosted_snippet_stats.yml)`
  - For end-to-end integration tests (like in `ProcessAwesomeListService` spec) that process a specific repository and all its nested API calls (README fetch, stats for all links), use a comprehensive name:
    - Example: `[polycarbohydrate_awesome-tor.yml](mdc:spec/cassettes/github/polycarbohydrate_awesome-tor.yml)` (This cassette will be used by multiple specs and should contain all interactions for this repo across operations if `record: :new_episodes` is used consistently).

### Recording Mode
- When initially recording a cassette or when new HTTP interactions are expected (e.g., due to code changes or new data in a processed list), use `record: :new_episodes` in the `vcr()` helper or `VCR.use_cassette` call. This allows new interactions to be added to an existing cassette or a new one to be created.
  ```ruby
  vcr('github', 'polycarbohydrate_awesome-tor', record: :new_episodes) do
    # ... test code making API calls ...
  end
  ```
- For most subsequent test runs, VCR will replay from the existing cassette based on the default `record: :once` (if `ENV['VCR_RECORD_MODE']` is not set or is `:once`, as configured in `[vcr.rb](mdc:spec/support/vcr.rb)`).
- To force re-recording of all interactions for a cassette (or suite), either delete the cassette file(s) or run specs with the environment variable `VCR_RECORD_MODE=all`.

### GitHub API Key
- For reliable VCR recording against the GitHub API and to avoid rate limits, ensure the environment variable `GITHUB_API_KEY` is set with a valid GitHub Personal Access Token during test runs intended for recording cassettes. This token is automatically filtered from cassettes by the VCR configuration in `[vcr.rb](mdc:spec/support/vcr.rb)`.

### Custom `vcr` Helper
- The project uses a custom `vcr()` helper method defined in `[vcr.rb](mdc:spec/support/vcr.rb)`.
- This helper should be used in specs instead of `VCR.use_cassette` directly.
- It handles cassette directory structure (`github/` prefix often), filename sanitization, and automatic time-freezing to `cassette.originally_recorded_at` when replaying cassettes (if `vcr_time_travel?` is true).
- The precedence for `record:` mode in the helper is: direct options passed to `vcr()` > `ENV['VCR_RECORD_MODE']` > base defaults.
